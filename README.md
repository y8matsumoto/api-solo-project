# データベース パート II. Clack の構築

## 目次

1.  [前書き](#前書き)
1.  [はじめに](#はじめに)
1.  [トピックの概要](#トピックの概要)
    1.  [Knex](#knex)
    1.  [マイグレーション](#マイグレーション)
    1.  [ORMs](#orms)
1.  [環境設定](#環境設定)
    1.  [Postgres](#postgres)
    1.  [依存パッケージのインストールとスタートアップ](#依存パッケージとスタートアップ)
1.  [課題](#課題)
    1.  [基本課題](#基本課題)
    1.  [ボーナス課題](#ボーナス課題)
1.  [参考資料](#参考資料)

## 前書き

このプロジェクトはこれまで見てきたものよりも複雑で、既にたくさんのコードが書かれています。このスプリントがとても難しく感じるのは至って **当然** です。

以下はこのスプリント攻略の鍵です。

- 大規模なプロジェクトでは、別のチームに所属したり、開発者が別のタスクやプロジェクトの一部を作業することになるため、すべてを理解するための十分な時間がありません。
- 特定のタスクを担当し、あなたが担当する部分が所がコードベースのコードベースのどこで作業する必要があるかを優先的に見つけましょう。
- VSCode はあなたの友達です。`CMD + P` を使用してファイル間をすばやく移動したり、ショートカットコマンドを使って「migration」などの用語を検索しましょう。
- あなたがすべてを把握していなくても「大丈夫でしょ。」という姿勢で保つ必要があります。どんなに優秀な人でも全ては知りません。とにかく手を動かしていきましょう

## はじめに

このスプリントでは、シンプルなチャットアプリ `Clack - The Crappy Slack` のバックエンドを構築します。  
[knex](http://knexjs.org/) を使用すると SQL を書かずともデータベースとやりとりすることができるので、データベース(SQL) を意識せずにビジネスロジックに集中することができます。また、knex にはマイグレーションの機能も備わっているので、開発中に行ったスキーマ変更も柔軟に行うことができます。  
このアプリは以下のような機能が必要です。

- お互いにメッセージを送受信する。
- チャンネルを作成する。
- チャンネルに参加する。
- 参加したチャンネルからメッセージを送受信する。

このスプリントでは、ルーティングとフロントエンド部分は、既に実装してあります。今回の課題では、ほとんどの時間をデータベースとのやりとり部分に注力しましょう。

## トピックの概要

### Knex

前回の課題では、生の SQL を記述してデータベースとやり取りをしました。ご想像のとおり、これは時として苦痛であるため、SQL をより javascript ライクな方法で記述できるライブラリを使用して Node でデータベースとやり取りすることをお勧めします。[Knex](http://knexjs.org/) はこのためのデファクトスタンダードなライブラリであり、このスプリントでは Knex を頻繁に利用します。Knex のドキュメントを頻繁に読むことになるため、ドキュメントを 1 つのタブに開いたままにしておくことをお勧めします。簡単に言うと、knex はクエリビルダーです。つまり、Knex は、通常の Javascript でクエリを記述し、それを SQL に変換することができます。恐れてはいけません。それを受け入れましょう。

### マイグレーション

テーブルのスキーマを変更するたびに、マイグレーション内でスキーマの変更を行います。マイグレーションとは、何らかの方法でスキーマを変更し、新しいスキーマに適合するようにデータを修正する一連のクエリです。マイグレーションは _常に_ トランザクション内で行われるべきです。トランザクションについてよくわからない場合は、前のスプリントの追加課題の説明を読むことで、このスプリントで必要となるトランザクションについて理解することができます。

困った時は、必要であればトランザクションに関する[この短いチュートリアル](https://www.tutorialspoint.com/postgresql/postgresql_transactions.htm)を試してみましょう。

### ORMs

ORM はオブジェクト関係マッピング（Object Relational Mapping）の略であり、データベースの出力結果をオブジェクトに変換します。データベースの出力結果とオブジェクトの違いは、オブジェクトはメソッドを持つことができ、そのメソッドはあらゆる種類の処理を実行するのに利用されるという点です。このスプリントでは、ユーザー、メッセージ、およびチャンネル用のクラスを作成します。クラスが提供してくれる標準化と予測性について理解してもらえるとうれしいです。

Node 用に作成されたいくつかの ORM ライブラリがあることに注意してください。一般的に次の理由により、意図的にそれらを今回使用していません。

- それらのライブラリはまだあまり成熟していません…。単純なユースケースではうまく機能しますが、ほとんどのプロジェクトではすぐに手がつけられなくなります。
- 現実の世界で、ORM がどのように機能するかについて学習してほしいと考えています。

## 環境設定

### Postgres

postgres をインストールする必要があります。もし、まだインストールしていない場合は、[PostgresApp](https://postgresapp.com/) をダウンロードしてインストールし、ターミナルで `psql` コマンドを実行して postgres が起動していることを確認しましょう。

次のコマンドを実行して、このプロジェクトのデータベースを作成しましょう：

```bash
  echo "CREATE DATABASE clack;" | psql
```

### 依存パッケージのインストールとアプリの起動手順

コマンドの例：

依存パッケージをインストールするには：

```bash
  npm i
```

マイグレーションを実行し、データベースをセットアップするには：

```bash
  npm run migrate
```

マイグレーションをロールバックするには：

```bash
  npm run rollback
```

テストを実行するには：

```bash
  npm run test
```

アプリを実行するには：

```bash
  npm run start
```

開発時にアプリを実行するには：

```bash
  npm run dev
```

## 課題

### 基本課題

- これから作成するバックエンドに合わせて、非常にシンプルなクライアントアプリを用意しておきました。

  - まず最初に `npm i` コマンドを実行して依存パッケージをインストールしましょう。
  - アプリを表示するために、`npm run dev` コマンドを実行してアプリを起動しましょう。
  - ブラウザで `localhost：3000` にアクセスしましょう。
  - バックエンドはまだ完全に実装されていないため、ほとんどの機能は正しく動作しません。唯一動作するのは、ユーザの作成/サイン部分の機能のみです。
  - これからみなさんは、チャンネル情報の取得、ユーザ情報の取得、メッセージの送受信の機能を実装する必要があります。

- 今回作成するような API をテストするには、[Insomnia](https://insomnia.rest/) もしくは [Postman](https://www.getpostman.com/) のような API をテストするツールがあると便利です。

- [ ] 20〜30 分程度かけて、リポジトリのレイアウトを理解しましょう。どのように機能するのかという点に特に注目してください。

  - `config.js` に含まれる設定情報は `index.js` で読み込まれています。
  - `models/index.js` には、knex を使ったデータベースへの接続情報がサブモジュールとして渡されます。
  - その中で `models/users/index.js` が展開されています。ここで定義されているすべてのメソッドに `User` クラスと `knex` の情が渡されます。
  - さらに上記ファイルから呼び出されている `models/users/create.js` では、User クラスの `serialize` メソッドを使って標準化された user モデルを返します。
  - `controllers/user/index.js` では、`models` メソッドを使用して基本的な CRUD 操作を実行しています。

- [ ] まず最初に、マイグレーションを実行しましょう。

  - [ ] `npm run migrate` コマンドを実行して、最初のマイグレーションを実行します。
  - [ ] うまく実行できない場合は、 `config.js` に書かれているデータベースの接続情報が正しいかどうかチェックしてください。特に、データベースのユーザ名、パスワードは要チェックです！
  - [ ] データベースに `users` テーブルが作成されていることを確認してください。psql を使用して確認できます。

- [ ] テスト（specs）をパスさせましょう。

  - [ ] `users > #list` のテストがパスするように、`models.users.list` を修正しましょう。

    - 何を書けば良いかわからない場合は、テストファイルを見て何を行うべきか確認しましょう。[Knex - select](https://knexjs.org/#Builder-select) のドキュメントが参考になるかもしれません。

  - [ ] `channels` テーブルを作成するマイグレーションファイルを追加しましょう。

    - `npm run makeMigrate -- add_channels_table` コマンドを実行して、新しいマイグレーションファイルを作成しましょう。
      - `models/migrations` フォルダに新しいファイルが作成されたましたか？
    - 作成されたファイルに、`id` 列と `name` 列を持つ `channels` テーブルを作成するための定義を記載しましょう。
      - `models/migrations/`にある既存のマイグレーションファイルを参考してください。
      - 今回追加する `id` 列と `name` 列の型は何が適切でしょうか？その辺りも意識しましょう。
    - `npm run migrate` でマイグレーションの実行、`npm run rollback` でマイグレーションをロールバックすることができます。
    - マイグレーションが成功したら、正しくテーブルが作成されているかデータベースを確認してください。

  - [ ] `models/channels` フォルダにある `create.js` と `list.js` 内のメソッドを完成させ、`channels > #create`, `channels > #list` のテストをパスさせましょう。

    - 何を書けば良いかわからない場合は、テストファイルを見て何を行うべきか確認しましょう。

  - [ ] `channel_messages` テーブルを作成するマイグレーションファイルを追加しましょう。

    - `npm run makeMigrate -- add_channel_messages_table` を実行して、新しいマイグレーションファイルを作成しましょう。
    - このテーブルには、`id`、`channel_id`、`from_id`、`message`、`sent_at` の列を含める必要があります。
    - `channel_id` には、`channel` テーブルに関連付けられた外部キーの設定をしてください。
    - `from_id` には、`users` テーブルに関連付けられた外部キーの設定をしてください。
    - それぞれの列に適切な型を定義しましょう。
    - 作成したら、`npm run migrate` でマイグレーションを実行しましょう。
    - マイグレーションが成功したら、正しくテーブルが作成されているかデータベースを確認してください。

  - [ ] `models/channelMessages` フォルダにある の `create.js` と `list.js` 内のメソッドを完成させ、`channel_messages > #create`, `channel_messages > #list` のテストをパスさせましょう。

    - create メソッドでは、新しいメッセージを作成した後、そのチャンネル内のすべてのメッセージを ChannelMessages として返す必要があることに注意してください。
    - 何を書けば良いかわからない場合は、テストファイルを見て何を行うべきか確認しましょう。

  - [ ] `user_messages` テーブルを作成するマイグレーションファイルを追加しましょう。

    - `npm run makeMigrate -- add_user_messages_table` を実行して、新しいマイグレーションファイルを作成しましょう。
    - このテーブルには、`id`、`from_id`、`to_id`、`message`、`sent_at` の列を含める必要があります。
    - `from_id`、`to_id` には、どこかのテーブルに関連付けられた外部キーの設定をする必要があります。どのテーブルが適切か考えて設定を行いましょう。
    - それぞれの列に適切な型を定義しましょう。
    - 作成したらマイグレーションを実行しましょう。
    - マイグレーションが成功したら、正しくテーブルが作成されているかデータベースを確認してください。

  - [ ] `models/userMessages` フォルダにある `create.js` と `list.js` 内のメソッドを完成させ、`userMessages` のテストをパスさせましょう。

    - ここでは、特定のペアユーザの情報を作成・取得する必要があります。

  - [ ] ここまでできたら、`npm run start` コマンドを実行してアプリを起動し、ブラウザからアプリの動作を確認してみてください。すべてがうまくいくとユーザのログイン、チャンネルの切り替え、チャットの投稿ができるはずです！

おめでとうございます！🎉🎉🎉

### ボーナス課題

この課題の実施は任意ですが、是非トライしてみましょう！

- [ ] シードデータの作成

  - シードファイルを使用すると、あらかじめ用意しておいたデータをデータベースに追加することができます。
  - [Knex - Seed files](https://knexjs.org/#Seeds) を参考にして、デフォルトのチャンネル情報をシードファイルで作成しましょう。

- [ ] さらにリッチなアプリにするために、様々な機能を追加してみましょう。

## 参考資料

- [Knex ドキュメント](http://knexjs.org/)
- [トランザクションに関する簡単なチュートリアル](https://www.tutorialspoint.com/postgresql/postgresql_transactions.htm)
- [Express v4.x ドキュメント](https://expressjs.com/ja/4x/api.html)
- [Chai アサーションライブラリ](http://chaijs.com/api/)
